// Liquidity Pool Intelligence - Database Schema
// Single user system - no authentication needed

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// CONFIGURAÇÕES DO USUÁRIO (single user)
// ========================================
model Settings {
  id                   Int         @id @default(1)
  totalBankroll        Decimal     @default(10000) @db.Decimal(20, 2)
  riskProfile          RiskProfile @default(NORMAL)
  maxPercentPerPool    Decimal     @default(5) @db.Decimal(5, 2)
  maxPercentPerNetwork Decimal     @default(25) @db.Decimal(5, 2)
  maxPercentVolatile   Decimal     @default(20) @db.Decimal(5, 2)
  enabledNetworks      String[]    @default(["ethereum", "arbitrum"])
  allowedPairTypes     String[]    @default(["stable_stable", "bluechip_stable"])
  telegramChatId       String?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
}

enum RiskProfile {
  DEFENSIVE
  NORMAL
  AGGRESSIVE
}

// ========================================
// CACHE DE POOLS ANALISADAS
// ========================================
model Pool {
  id             String   @id // formato: network_dex_address
  network        String   // ethereum, arbitrum, base
  dex            String   // uniswap_v3
  address        String   // endereço do contrato da pool
  token0Symbol   String
  token1Symbol   String
  token0Address  String
  token0Decimals Int      @default(18)
  token1Address  String
  token1Decimals Int      @default(18)
  feeTier        Int      // 100, 500, 3000, 10000 (basis points)
  tvlUsd         Decimal  @db.Decimal(20, 2)
  volume24hUsd   Decimal  @db.Decimal(20, 2)
  volume7dUsd    Decimal  @db.Decimal(20, 2)
  currentPrice   Decimal  @db.Decimal(30, 18)
  currentTick    Int?
  aprEstimate    Decimal? @db.Decimal(10, 4)
  pairType       String   // stable_stable, bluechip_stable, altcoin_stable
  isActive       Boolean  @default(true)
  lastScannedAt  DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ranges    PoolRange[]
  positions Position[]
  alerts    Alert[]
  history   HistoryEntry[]

  @@index([network])
  @@index([pairType])
  @@index([tvlUsd])
}

// ========================================
// RANGES SUGERIDOS PARA CADA POOL
// ========================================
model PoolRange {
  id             String    @id @default(cuid())
  poolId         String
  pool           Pool      @relation(fields: [poolId], references: [id], onDelete: Cascade)
  rangeType      RangeType
  priceLower     Decimal   @db.Decimal(30, 18)
  priceUpper     Decimal   @db.Decimal(30, 18)
  tickLower      Int?
  tickUpper      Int?
  score          Int       // 0-100
  feesEstimate7d Decimal   @db.Decimal(10, 4) // % do capital
  ilEstimate7d   Decimal   @db.Decimal(10, 4) // % do capital
  gasEstimate    Decimal   @db.Decimal(10, 2) // USD
  netReturn7d    Decimal   @db.Decimal(10, 4) // % do capital
  timeInRange7d  Decimal   @db.Decimal(5, 2) // % do tempo
  capitalPercent Decimal   @db.Decimal(5, 2) // % da banca sugerido
  capitalUsd     Decimal   @db.Decimal(20, 2) // valor em USD sugerido
  riskLevel      String    // low, medium, high
  explanation    String    @db.Text // explicação em linguagem humana
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([poolId, rangeType])
  @@index([score])
}

enum RangeType {
  DEFENSIVE
  OPTIMIZED
  AGGRESSIVE
}

// ========================================
// POSIÇÕES (reais on-chain ou simuladas)
// ========================================
model Position {
  id           String         @id @default(cuid())
  poolId       String
  pool         Pool           @relation(fields: [poolId], references: [id], onDelete: Cascade)
  tokenId      String?        // NFT ID se posição real
  walletAddress String?       // endereço da carteira
  isSimulation Boolean        @default(true)
  priceLower   Decimal        @db.Decimal(30, 18)
  priceUpper   Decimal        @db.Decimal(30, 18)
  tickLower    Int?
  tickUpper    Int?
  capitalUsd   Decimal        @db.Decimal(20, 2)
  liquidity    String?        // liquidity amount (big number as string)
  entryPrice   Decimal?       @db.Decimal(30, 18)
  entryDate    DateTime       @default(now())
  exitDate     DateTime?
  status       PositionStatus @default(ACTIVE)
  feesAccrued  Decimal        @default(0) @db.Decimal(20, 6)
  ilAccrued    Decimal        @default(0) @db.Decimal(20, 6)
  pnlUsd       Decimal        @default(0) @db.Decimal(20, 2)
  lastSyncAt   DateTime?
  notes        String?        @db.Text
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  history HistoryEntry[]

  @@index([status])
  @@index([isSimulation])
}

enum PositionStatus {
  ACTIVE
  ATTENTION
  CRITICAL
  CLOSED
}

// ========================================
// HISTÓRICO DE AÇÕES
// ========================================
model HistoryEntry {
  id         String    @id @default(cuid())
  poolId     String
  pool       Pool      @relation(fields: [poolId], references: [id], onDelete: Cascade)
  positionId String?
  position   Position? @relation(fields: [positionId], references: [id], onDelete: SetNull)
  action     String    // ENTRY, REBALANCE, EXIT, ALERT, RECOMMENDATION
  details    Json      // detalhes específicos da ação
  createdAt  DateTime  @default(now())

  @@index([poolId])
  @@index([action])
  @@index([createdAt])
}

// ========================================
// ALERTAS ENVIADOS
// ========================================
model Alert {
  id           String   @id @default(cuid())
  poolId       String?
  pool         Pool?    @relation(fields: [poolId], references: [id], onDelete: SetNull)
  type         String   // MAINTENANCE, RISK, OPPORTUNITY
  severity     String   // INFO, WARNING, CRITICAL
  title        String
  message      String   @db.Text
  data         Json?    // dados adicionais
  sentAt       DateTime @default(now())
  acknowledged Boolean  @default(false)

  @@index([type])
  @@index([severity])
  @@index([sentAt])
}

// ========================================
// CACHE DE PREÇOS
// ========================================
model PriceCache {
  id        String   @id // token address ou symbol
  symbol    String
  network   String   @default("ethereum")
  priceUsd  Decimal  @db.Decimal(30, 18)
  updatedAt DateTime @updatedAt

  @@index([symbol])
}

// ========================================
// BACKUP LOG
// ========================================
model BackupLog {
  id        String   @id @default(cuid())
  filename  String
  size      Int      // bytes
  status    String   // SUCCESS, FAILED
  error     String?
  createdAt DateTime @default(now())
}
